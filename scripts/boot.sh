#!/bin/bash
SECTORSIZE=512
BOOTLOADER_INCLUDE_FILE=initium/boot0.h
BOOT1_STARTING_SECTOR_LOCATION=2
BOOT1_BINARY_LOCATION=initium/boot1.bin
BOOT1_BINARY_FILESIZE=$(stat -c%s "$BOOT1_BINARY_LOCATION")
KERNEL_BINARY_LOCATION=nucleus/kernel.bin
KERNEL_BINARY_FILESIZE=$(stat -c%s "$KERNEL_BINARY_LOCATION")
BOOT1_BINARY_ROUNDUP_SIZE=$((BOOT1_BINARY_FILESIZE+SECTORSIZE))
BOOT1_BINARY_FINAL_SIZE=$((BOOT1_BINARY_ROUNDUP_SIZE/SECTORSIZE))
KERNEL_BINARY_ROUNDUP_SIZE=$((KERNEL_BINARY_FILESIZE+SECTORSIZE))
KERNEL_BINARY_FINAL_SIZE=$((KERNEL_BINARY_ROUNDUP_SIZE/SECTORSIZE))

echo "$KERNEL_BINARY_FINAL_SIZE" > $BOOTLOADER_INCLUDE_FILE
sed -i '1s/^/.set I386_KERNEL_SIZE, /' $BOOTLOADER_INCLUDE_FILE
sed -i '1 a .set I386_BOOT1_SIZE, ' $BOOTLOADER_INCLUDE_FILE
echo "$(cat $BOOTLOADER_INCLUDE_FILE)$BOOT1_BINARY_FINAL_SIZE" > $BOOTLOADER_INCLUDE_FILE
sed -i '1 a .set I386_BOOT1_STARTING_SECTOR_LOCATION, ' $BOOTLOADER_INCLUDE_FILE
sed -i "s/I386_BOOT1_STARTING_SECTOR_LOCATION.*/\0$BOOT1_STARTING_SECTOR_LOCATION/" $BOOTLOADER_INCLUDE_FILE

KERNEL_STARTING_SECTOR_LOCATION=$((BOOT1_STARTING_SECTOR_LOCATION+BOOT1_BINARY_FINAL_SIZE))
BOOT1_FINAL_SECTOR_LOCATION=$((KERNEL_STARTING_SECTOR_LOCATION-1))

echo "Size of $BOOT1_BINARY_LOCATION = $BOOT1_BINARY_FILESIZE bytes."

if [[ "$BOOT1_BINARY_FINAL_SIZE" -gt 1 ]]; then
	echo "Sector count for $BOOT1_BINARY_LOCATION = $BOOT1_BINARY_FINAL_SIZE sectors."
else
	echo "Sector count for $BOOT1_BINARY_LOCATION = $BOOT1_BINARY_FINAL_SIZE sector."
fi

echo "First boot1 sector location is 0x$BOOT1_STARTING_SECTOR_LOCATION"
echo "Last boot1 sector location is 0x$BOOT1_FINAL_SECTOR_LOCATION"
sed -i '1 a .set I386_BOOT1_FINAL_SECTOR_LOCATION, ' $BOOTLOADER_INCLUDE_FILE
sed -i "s/I386_BOOT1_FINAL_SECTOR_LOCATION.*/\0$BOOT1_FINAL_SECTOR_LOCATION/" $BOOTLOADER_INCLUDE_FILE

KERNEL_FINAL_SECTOR_LOCATION=$((BOOT1_FINAL_SECTOR_LOCATION+KERNEL_BINARY_FINAL_SIZE))

echo "Size of $KERNEL_BINARY_LOCATION = $KERNEL_BINARY_FILESIZE bytes."

if [[ "$KERNEL_BINARY_FINAL_SIZE" -gt 1 ]]; then
	echo "Sector count for $KERNEL_BINARY_LOCATION = $KERNEL_BINARY_FINAL_SIZE sectors."
else
	echo "Sector count for $KERNEL_BINARY_LOCATION = $KERNEL_BINARY_FINAL_SIZE sector."
fi

echo "First kernel sector location is 0x$KERNEL_STARTING_SECTOR_LOCATION"
echo "Last kernel sector location is 0x$KERNEL_FINAL_SECTOR_LOCATION"

sed -i '1 a .set I386_KERNEL_STARTING_LOCATION, ' $BOOTLOADER_INCLUDE_FILE
sed -i "s/I386_KERNEL_STARTING_LOCATION.*/\0$KERNEL_STARTING_SECTOR_LOCATION/" $BOOTLOADER_INCLUDE_FILE
